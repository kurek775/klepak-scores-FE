<div class="max-w-4xl mx-auto p-8">
  <a [routerLink]="['/events', eventId]" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">{{ 'EVENTS.BACK' | transloco }}</a>

  @if (loading()) {
    <p class="text-gray-500 dark:text-gray-400 mt-6">{{ 'EVENTS.LOADING_LEADERBOARD' | transloco }}</p>
  } @else if (leaderboard(); as lb) {
    <div class="mt-4 mb-6 flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ lb.event_name }}</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ 'LEADERBOARD.TITLE' | transloco }}</p>
      </div>
      @if (diplomaTemplates().length > 0) {
        <button (click)="downloadAllDiplomas()" [disabled]="generatingPdf()"
          class="px-4 py-1.5 text-sm font-medium text-amber-700 dark:text-amber-300 bg-amber-50 dark:bg-amber-900/20 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors border border-amber-200 dark:border-amber-800 disabled:opacity-50 disabled:cursor-not-allowed">
          @if (generatingPdf()) { {{ 'DIPLOMA.GENERATING' | transloco }} }
          @else { {{ 'DIPLOMA.DOWNLOAD_ALL' | transloco }} }
        </button>
      }
    </div>

    @if (!lb.has_age_categories) {
      <div class="mb-5 flex items-start gap-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg px-4 py-3 text-sm text-amber-800 dark:text-amber-300">
        <span class="mt-0.5">&#9432;</span>
        <span>{{ 'LEADERBOARD.NO_AGE_BRACKETS_INFO' | transloco }}</span>
      </div>
    }

    @if (lb.activities.length === 0) {
      <p class="text-gray-500 dark:text-gray-400">{{ 'LEADERBOARD.NO_ACTIVITIES' | transloco }}</p>
    } @else {
      <div class="space-y-4">
        @for (activity of lb.activities; track activity.activity_id) {
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">

            <button
              (click)="toggleActivity(activity.activity_id)"
              class="w-full flex items-center gap-3 px-5 py-4 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            >
              <span class="font-semibold text-gray-900 dark:text-white flex-1 text-base">{{ activity.activity_name }}</span>
              <span class="text-xs text-gray-400 dark:text-gray-500 transition-transform" [class.rotate-90]="isExpanded(activity.activity_id)">
                &#9654;
              </span>
            </button>

            @if (isExpanded(activity.activity_id)) {
              <div class="border-t border-gray-100 dark:border-gray-700">
                @if (activity.categories.length === 0) {
                  <p class="px-5 py-3 text-sm text-gray-500 dark:text-gray-400">{{ 'LEADERBOARD.NO_RECORDS' | transloco }}</p>
                } @else {
                  @for (cat of activity.categories; track cat.gender + cat.age_category_name) {
                    <div class="border-t border-gray-100 dark:border-gray-700 first:border-t-0">
                      <div class="px-5 py-2 bg-gray-50 dark:bg-gray-900/50 flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                          {{ genderLabel(cat.gender) }}
                        </span>
                        <span class="text-gray-400 dark:text-gray-600">·</span>
                        <span class="text-sm text-gray-600 dark:text-gray-400">{{ cat.age_category_name }}</span>
                      </div>

                      <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-900 border-b border-gray-100 dark:border-gray-700">
                          <tr>
                            <th class="text-left px-5 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-12">{{ 'LEADERBOARD.RANK' | transloco }}</th>
                            <th class="text-left px-5 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{{ 'LEADERBOARD.NAME' | transloco }}</th>
                            <th class="text-center px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-16">{{ 'LEADERBOARD.AGE' | transloco }}</th>
                            <th class="text-right px-5 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-24">{{ 'LEADERBOARD.SCORE' | transloco }}</th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50 dark:divide-gray-700">
                          @for (p of cat.participants; track p.participant_id) {
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                              <td class="px-5 py-2 text-sm text-center dark:text-gray-300">{{ rankMedal(p.rank) }}</td>
                              <td class="px-5 py-2 text-sm text-gray-900 dark:text-white">{{ p.display_name }}</td>
                              <td class="px-3 py-2 text-sm text-center text-gray-500 dark:text-gray-400">
                                {{ p.age !== null ? p.age : '—' }}
                              </td>
                              <td class="px-5 py-2 text-sm text-right font-semibold text-gray-900 dark:text-white">
                                {{ formatValue(p.value, activity.evaluation_type) }}
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
      </div>
    }
  } @else {
    <p class="text-gray-500 dark:text-gray-400 mt-6">{{ 'EVENTS.LEADERBOARD_UNAVAILABLE' | transloco }}</p>
  }
</div>
