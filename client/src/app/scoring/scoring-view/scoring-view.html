<div class="max-w-4xl mx-auto p-8">
  <a [routerLink]="['/events', eventId]" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">{{ 'SCORING.BACK' | transloco }}</a>

  @if (loading()) {
    <p class="text-gray-500 dark:text-gray-400 mt-6">{{ 'SCORING.LOADING' | transloco }}</p>
  } @else if (activity(); as act) {
    <div class="mt-4 mb-6 flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ act.name }}</h1>
        @if (act.description) {
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ act.description }}</p>
        }
      </div>
    </div>

    <!-- Offline pending banner -->
    @if (pendingCount() > 0) {
      <div class="mb-4 flex items-center justify-between bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg px-4 py-3 text-sm text-amber-800 dark:text-amber-300">
        <span>{{ 'SCORING.OFFLINE_PENDING' | transloco: { count: pendingCount() } }}</span>
        <button
          (click)="syncNow()"
          class="ml-4 px-3 py-1 bg-amber-500 text-white text-xs font-medium rounded-lg hover:bg-amber-600 transition-colors"
        >
          {{ 'SCORING.SYNC_NOW' | transloco }}
        </button>
      </div>
    }

    @if (rows().length === 0) {
      <p class="text-gray-500 dark:text-gray-400">{{ 'SCORING.NO_PARTICIPANTS' | transloco }}</p>
    } @else {
      <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">

        @if (processingAI()) {
          <div class="absolute inset-0 bg-white/60 dark:bg-gray-800/60 backdrop-blur-[2px] z-10 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-blue-700 dark:text-blue-400 font-semibold animate-pulse">{{ 'SCORING.AI_SCANNING' | transloco }}</p>
          </div>
        }

        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-900 border-b border-gray-100 dark:border-gray-700">
            <tr>
              <th class="text-left px-5 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{{ 'SCORING.PARTICIPANT' | transloco }}</th>
              <th class="text-left px-5 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{{ 'SCORING.SCORE' | transloco }}</th>
              <th class="text-center px-5 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{{ 'SCORING.STATUS' | transloco }}</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
            @for (row of rows(); track row.participant.id; let i = $index) {
              <tr
                class="transition-colors duration-300"
                [class.bg-green-50]="row.saved"
              >
                <td class="px-5 py-3 text-sm text-gray-900 dark:text-white">{{ row.participant.display_name }}</td>
                <td class="px-5 py-3">
                  @if (isBoolean) {
                    <button
                      (click)="toggleBoolean(row)"
                      class="w-10 h-6 rounded-full relative transition-colors"
                      [class]="row.value === '1' ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'"
                    >
                      <span
                        class="absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform"
                        [class.left-0.5]="row.value !== '1'"
                        [class.left-4]="row.value === '1'"
                      ></span>
                    </button>
                  } @else if (isNumeric) {
                    <input
                      type="number"
                      [(ngModel)]="row.value"
                      (ngModelChange)="onValueChange(row)"
                      class="w-24 px-3 py-1.5 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                      placeholder="0"
                    />
                  } @else {
                    <input
                      type="text"
                      [(ngModel)]="row.value"
                      (ngModelChange)="onValueChange(row)"
                      class="w-40 px-3 py-1.5 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    />
                  }
                </td>
                <td class="px-5 py-3 text-center">
                  @if (row.saved) {
                    <span class="text-xs text-green-600 dark:text-green-400 font-medium">{{ 'SCORING.SAVED' | transloco }}</span>
                  } @else if (row.value) {
                    <span class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">{{ 'SCORING.UNSAVED' | transloco }}</span>
                  } @else {
                    <span class="text-xs text-gray-400 dark:text-gray-500">â€”</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="mt-6 flex justify-end items-center gap-3">
        <input
          type="file"
          #cameraInput
          (change)="onPhotoSelected($event)"
          accept="image/*"
          capture="environment"
          class="hidden"
        >

        <button
          (click)="cameraInput.click()"
          [disabled]="processingAI() || saving()"
          class="flex items-center gap-2 px-5 py-2.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 text-sm font-medium rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors border border-indigo-200 dark:border-indigo-800"
        >
          <span>ðŸ“¸</span> {{ 'SCORING.AI_SCAN' | transloco }}
        </button>

        <button
          (click)="saveAll()"
          [disabled]="saving() || processingAI()"
          class="px-8 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
        >
          @if (saving()) {
            {{ 'SCORING.SAVING' | transloco }}
          } @else {
            {{ 'SCORING.SAVE_ALL' | transloco }}
          }
        </button>
      </div>
    }
  } @else {
    <p class="text-gray-500 dark:text-gray-400 mt-6">{{ 'SCORING.ACTIVITY_NOT_FOUND' | transloco }}</p>
  }
</div>

@if (showReviewModal()) {
  <app-ai-review-modal
    [imageUrl]="previewImageUrl()"
    [results]="pendingAIResults()"
    (confirm)="onAIConfirm($event)"
    (discard)="onAIDiscard()"
  />
}
